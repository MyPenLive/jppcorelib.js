var Deffered,EventDispatcher,Kazitori,delegater,escapeRegExp,namedParam,optionalParam,routeStripper,splatParam,trailingSlash,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1},__hasProp={}.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};delegater=function(a,b){return function(){return b.apply(a,arguments)}},trailingSlash=/\/$/,routeStripper=/^[#\/]|\s+$/g,escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g,namedParam=/:\w+/g,optionalParam=/\((.*?)\)/g,splatParam=/\*\w+/g,Kazitori=function(){function a(a){this.beforeFaild=__bind(this.beforeFaild,this),this.beforeComplete=__bind(this.beforeComplete,this);var b,c;this.options=a||(a={}),a.routes&&(this.routes=a.routes),this.root=a.root?a.root:"/",c=window,typeof c!="undefined"&&(this.location=c.location,this.history=c.history),b=document.docmentMode,this.isOldIE=c.navigator.userAgent.toLowerCase().indexOf("msie")!==-1&&(!b||b<7),this._dispatcher=new EventDispatcher,this._bindBefores(),this._bindRules(),(__indexOf.call(a,"isAutoStart")<0||a.isAutoStart!==!1)&&this.start();return}return a.prototype.VERSION="0.1.3",a.prototype.history=null,a.prototype.location=null,a.prototype.handlers=[],a.prototype.beforeHandlers=[],a.prototype.afterhandlers=[],a.prototype.root=null,a.prototype.beforeAnytimeHandler=null,a.prototype.beforeFaildHandler=function(){},a.prototype.isBeforeForce=!1,a.prototype.breaker={},a.prototype._dispatcher=null,a.prototype._beforeDeffer=null,a.prototype.start=function(b){var c,d,e,f;if(a.started)throw new Error("mou hazim matteru");a.started=!0,f=window,this.options=this._extend({},{root:"/"},this.options,b),this._hasPushState=!!this.history&&!!this.history.pushState,this._wantChangeHash=this.options.hashChange!==!1,d=this.getFragment(),c=this.location.pathname.replace(/[^\/]$/,"$&/")===this.root,this.isOldIE&&this._wantChangeHash&&(e=document.createElement("iframe"),e.setAttribute("src","javascript:0"),e.setAttribute("tabindex","-1"),e.style.display="none",document.body.appendChild(e),this.iframe=e.contentWindow,this.change(d)),this._hasPushState===!0?f.addEventListener("popstate",delegater(this,this.observeURLHandler)):this._wantChangeHash===!0&&__indexOf.call(f,"onhashchange")>=0&&!this.isOldIE&&f.addEventListener("hashchange",delegater(this,this.observeURLHandler)),this._hasPushState&&c&&this.location.hash&&(this.fragment=this.getHash().replace(routeStripper,""),this.history.replaceState({},document.title,this.root+this.fragment+this.location.search));if(!this.options.silent)return this.loadURL()},a.prototype.stop=function(){var a;return a=window,a.removeEventListener("popstate",arguments.callee),a.removeEventListener("hashchange",arguments.callee)},a.prototype.change=function(b,c){var d,e,f,g;if(!a.started)return!1;f=this.fragment,c||(c={trigger:c}),d=this.getFragment(b||"");if(this.fragment===d)return;this.fragment=d,e=this.fragment,g=this.root+d;if(this._hasPushState)this.history[c.replace?"replaceState":"pushState"]({},document.title,g);else{if(!this._wantChangeHash)return this.location.assign(g);this._updateHash(this.location,d,c.replace),this.iframe&&d!==this.getFragment(this.getHash(this.iframe))&&(c.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,d,c.replace))}this._dispatcher.dispatchEvent({type:KazitoriEvent.CHANGE,prev:f,next:e}),this.loadURL(d)},a.prototype.registHandler=function(a,b,c,d){var e;return typeof a!==RegExp&&(a=this._ruleToRegExp(a)),d||(d=c?this._bindFunctions(b):this[b]),e=c?this.beforeHandlers:this.handlers,e.unshift({rule:a,callback:this._binder(function(b){var c;return c=this._extractParams(a,b),d&&d.apply(this,c)},this)}),this},a.prototype.loadURL=function(a){var b,c,d,e,f,g,h,i=this;b=this.fragment=this.getFragment(a),d=[],this._beforeDeffer=new Deffered,this._beforeDeffer.queue=[],this._beforeDeffer.index=-1,this.beforeAnytimeHandler!=null&&this._beforeDeffer.deffered(function(a){i.beforeAnytimeHandler.callback(b),a.execute(a)}),e=0,h=this.beforeHandlers;for(f=0,g=h.length;f<g;f++)c=h[f],c.rule.test(b)===!0&&this._beforeDeffer.deffered(function(a){c.callback(b),a.execute(a)});return this._beforeDeffer.addEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.addEventListener(KazitoriEvent.TASK_QUEUE_FAILD,this.beforeFaild),this._beforeDeffer.execute(this._beforeDeffer)},a.prototype.beforeComplete=function(a){var b,c,d,e,f;this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_COMPLETE,this.beforeComplete),this._beforeDeffer.removeEventListener(KazitoriEvent.TASK_QUEUE_FAILD,this.beforeFaild),c=[],this._beforeDeffer.queue=[],this._beforeDeffer.index=-1,f=this.handlers;for(d=0,e=f.length;d<e;d++)b=f[d],b.rule.test(this.fragment)&&(b.callback(this.fragment),c.push(!0));return c},a.prototype.beforeFaild=function(a){return this.beforeFaildHandler.apply(this,arguments),this.isBeforeForce&&this.beforeComplete(),this._beforeDeffer=null},a.prototype.observeURLHandler=function(a){var b;return b=this.getFragment(),b===this.fragment&&this.iframe&&(b=this.getFragment(this.getHash(this.iframe))),b===this.fragment?!1:(this.iframe&&this.change(b),this.loadURL()||this.loadURL(this.getHash()))},a.prototype._bindRules=function(){var a,b,c,d;if(this.routes==null)return;a=this._keys(this.routes);for(c=0,d=a.length;c<d;c++)b=a[c],this.registHandler(b,this.routes[b],!1)},a.prototype._bindBefores=function(){var a,b,c,d,e;if(this.befores==null)return;a=this._keys(this.befores);for(d=0,e=a.length;d<e;d++)c=a[d],this.registHandler(c,this.befores[c],!0);this.beforeAnytime&&(b=this._bindFunctions(this.beforeAnytime),this.beforeAnytimeHandler={callback:this._binder(function(a){var c;return c=[a],b&&b.apply(this,c)},this)})},a.prototype._updateHash=function(a,b,c){var d;c?(d=a.href.replace(/(javascript:|#).*$/,""),a.replace(d+"#"+b)):a.hash="#"+b},a.prototype.getFragment=function(a){var b;return a==null&&(this._hasPushState||!this._wantChangeHash?(a=this.location.pathname,b=this.root.replace(trailingSlash,""),a.indexOf(b)||(a=a.substr(b.length))):a=this.getHash()),a.replace(routeStripper,"")},a.prototype.getHash=function(){var a;return a=(window||this).location.href.match(/#(.*)$/),a!=null?a[1]:""},a.prototype._extractParams=function(a,b){var c;return c=a.exec(b),c!=null?c.slice(1):null},a.prototype._ruleToRegExp=function(a){var b;return b=a.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,"([^/]+)").replace(splatParam,"(.*?)"),new RegExp("^"+b+"$")},a.prototype.addEventListener=function(a,b){return this._dispatcher.addEventListener(a,b)},a.prototype.removeEventListener=function(a,b){return this._dispatcher.removeEventListener(a,b)},a.prototype.dispatchEvent=function(a){return this._dispatcher.dispatchEvent(a)},a.prototype._slice=Array.prototype.slice,a.prototype._keys=Object.keys||function(a){var b,c;if(a===!Object(a))throw new TypeError("object ja nai");c=[];for(b in a)Object.hasOwnProperty.call(a,b)&&(c[c.length]=b);return c},a.prototype._binder=function(a,b){var c,d;return d=this._slice,c=d.call(arguments,2),function(){return a.apply(b||{},c.concat(d.call(arguments)))}},a.prototype._extend=function(a){return this._each(this._slice.call(arguments,1),function(b){var c,d;if(b){d=[];for(c in b)d.push(a[c]=b[c]);return d}}),a},a.prototype._each=function(a,b,c){var d,e,f,g;if(a==null)return;d=Array.prototype.forEach;if(d&&a.forEach===d)return a.forEach(b,c);if(a.length===+a.length){e=0,g=a.length;while(e<g){if(b.call(c,a[e],e,a)===this.breaker)return;e++}}else for(f in a)if(__indexOf.call(a,f)>=0&&b.call(c,a[f],f,a)===this.breaker)return},a.prototype._bindFunctions=function(a){var b,c,d,e,f,g,h,i,j,k,l;typeof a=="string"&&(a=a.split(",")),b=[];for(k=0,l=a.length;k<l;k++){f=a[k],e=this[f];if(e==null){i=f.split(".");if(i.length>1){d=window[i[0]],g=1,h=i.length;while(g<h){j=d[i[g]];if(j==null)break;d=j,g++}e=d}else e=window[f]}e!=null&&b.push(e)}return c=function(a){var c,d;for(c=0,d=b.length;c<d;c++)e=b[c],e.apply(this,[a])},c},a}(),EventDispatcher=function(){function a(){}return a.prototype.listeners={},a.prototype.addEventListener=function(a,b){this.listeners[a]===void 0&&(this.listeners[a]=[]),this.listeners[a].indexOf(b===-1)&&this.listeners[a].push(b)},a.prototype.removeEventListener=function(a,b){var c;c=this.listeners[a].indexOf(b),c!==-1&&this.listeners[a].splice(c,1)},a.prototype.dispatchEvent=function(a){var b,c,d,e;b=this.listeners[a.type];if(b!==void 0){a.target=this;for(d=0,e=b.length;d<e;d++)c=b[d],c.call(this,a)}},a}(),Deffered=function(a){function b(){this.queue=[],this.index=-1}return __extends(b,a),b.prototype.queue=[],b.prototype.index=-1,b.prototype.deffered=function(a){return this.queue.push(a),this},b.prototype.execute=function(){this.index++;try{if(this.queue[this.index]){this.queue[this.index].apply(this,arguments);if(this.queue.length===this.index)return this.queue=[],this.index=-1,this.dispatchEvent({type:KazitoriEvent.TASK_QUEUE_COMPLETE})}}catch(a){return this.reject(a)}},b.prototype.reject=function(a){return this.dispatchEvent({type:KazitoriEvent.TASK_QUEUE_FAILD,index:this.index,message:a.message})},b}(EventDispatcher),function(a){var b;return b={},b.TASK_QUEUE_COMPLETE="task_queue_complete",b.TASK_QUEUE_FAILD="task_queue_faild",b.CHANGE="change",a.KazitoriEvent=b}(window),Kazitori.started=!1